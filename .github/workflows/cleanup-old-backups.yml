name: Cleanup Old Backups

# Run once a year to clean backups older than 2 years
on:
  schedule:
    - cron: '0 0 1 1 *'  # January 1st at midnight
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Remove backups older than 2 years
      run: |
        cd backups
        
        # Get current year
        CURRENT_YEAR=$(date +%Y)
        CUTOFF_YEAR=$((CURRENT_YEAR - 2))
        
        echo "Current year: $CURRENT_YEAR"
        echo "Will delete backups from before: $CUTOFF_YEAR"
        
        # Find and delete old backup files
        for file in *.json 2>/dev/null; do
          # Extract year from filename (e.g., 05Oct2023_connect.json)
          YEAR=$(echo "$file" | grep -oP '\d{4}' | head -1)
          
          if [ -n "$YEAR" ] && [ "$YEAR" -lt "$CUTOFF_YEAR" ]; then
            echo "Deleting old backup: $file (year: $YEAR)"
            rm "$file"
          fi
        done
        
        echo "Cleanup completed"
    
    - name: Commit deletions
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add backups/
        
        if git diff --staged --quiet; then
          echo "No backups to delete"
        else
          git commit -m "Cleanup: Remove backups older than 2 years"
          git push
          echo "Old backups removed and changes pushed"
        fi
